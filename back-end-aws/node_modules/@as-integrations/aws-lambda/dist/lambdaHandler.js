"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.startServerAndCreateLambdaHandler = startServerAndCreateLambdaHandler;
function startServerAndCreateLambdaHandler(server, handler, options) {
    server.startInBackgroundHandlingStartupErrorsByLoggingAndFailingAllRequests();
    const defaultContext = async () => ({});
    const contextFunction = options?.context ?? defaultContext;
    return async function (event, context) {
        const resultMiddlewareFns = [];
        try {
            for (const middlewareFn of options?.middleware ?? []) {
                const middlewareReturnValue = await middlewareFn(event);
                if (typeof middlewareReturnValue === 'object' &&
                    middlewareReturnValue !== null) {
                    return middlewareReturnValue;
                }
                if (middlewareReturnValue) {
                    resultMiddlewareFns.push(middlewareReturnValue);
                }
            }
            const httpGraphQLRequest = handler.fromEvent(event);
            const response = await server.executeHTTPGraphQLRequest({
                httpGraphQLRequest,
                context: () => {
                    return contextFunction({
                        event,
                        context,
                    });
                },
            });
            const result = handler.toSuccessResult(response);
            for (const resultMiddlewareFn of resultMiddlewareFns) {
                await resultMiddlewareFn(result);
            }
            return result;
        }
        catch (e) {
            const result = handler.toErrorResult(e);
            for (const resultMiddlewareFn of resultMiddlewareFns) {
                await resultMiddlewareFn(result);
            }
            return result;
        }
    };
}
//# sourceMappingURL=lambdaHandler.js.map